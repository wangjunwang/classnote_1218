// entry/src/main/ets/pages/CalendarPage.ets
import { dbHelper, Student, CourseRecord, InspirationRecord, TodoRecord } from '../db/DBHelper';
import { common } from '@kit.AbilityKit';
import { NotificationHelper } from '../utils/NotificationHelper';

// UIå±‚ä½¿ç”¨çš„åˆ†ç»„æ¥å£
interface StudentGroup {
  name: string;        // åˆ†ç»„åç§° (ä½œä¸ºå”¯ä¸€æ ‡è¯†)
  studentIds: number[]; // åŒ…å«çš„å­¦ç”ŸID
}

// =======================
// 1. æ’è¯¾å¼¹çª—
// =======================
@CustomDialog
struct AddCourseDialog {
  controller: CustomDialogController
  students: Student[] = []
  groups: StudentGroup[] = []

  confirm: (studentIds: number[], hour: number, minute: number, note: string, groupName?: string) => void = () => {}

  @State selectedStudentIds: number[] = []
  @State note: string = ''

  @State hours: string[] = []
  @State minutes: string[] = []
  @State selectedHour: string = '10'
  @State selectedMinute: string = '00'

  @State currentGroupName: string = ''

  aboutToAppear() {
    for (let i = 0; i < 24; i++) this.hours.push(i.toString().padStart(2, '0'));
    for (let i = 0; i < 60; i++) this.minutes.push(i.toString().padStart(2, '0'));
  }

  toggleStudent(id: number) {
    if (this.selectedStudentIds.includes(id)) {
      this.selectedStudentIds = this.selectedStudentIds.filter(sid => sid !== id);
    } else {
      this.selectedStudentIds.push(id);
    }
    this.checkGroupMatch();
  }

  toggleGroup(group: StudentGroup) {
    if (this.currentGroupName === group.name) {
      this.selectedStudentIds = [];
      this.currentGroupName = '';
    } else {
      this.selectedStudentIds = [...group.studentIds];
      this.currentGroupName = group.name;
    }
  }

  checkGroupMatch() {
    this.currentGroupName = '';
    const matched = this.groups.find(g =>
    g.studentIds.length === this.selectedStudentIds.length &&
    g.studentIds.every(id => this.selectedStudentIds.includes(id))
    );
    if (matched) {
      this.currentGroupName = matched.name;
    }
  }

  getGridHeight(): number {
    if (this.students.length <= 6) return 100;
    else return 180;
  }

  build() {
    Column({ space: 20 }) {
      Text('å®‰æ’è¯¾ç¨‹').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 10 }).fontColor($r('app.color.text_primary'))

      if (this.groups.length > 0) {
        Column({ space: 10 }) {
          Text('å¿«æ·åˆ†ç»„').fontSize(16).fontColor($r('app.color.text_secondary')).width('100%')
          List({ space: 10 }) {
            ForEach(this.groups, (group: StudentGroup) => {
              ListItem() {
                Text(group.name)
                  .fontSize(14)
                  .fontColor(this.currentGroupName === group.name ? Color.White : $r('app.color.picker_selected_blue'))
                  .fontWeight(FontWeight.Medium)
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .backgroundColor(this.currentGroupName === group.name ? $r('app.color.picker_selected_blue') : '#E6F2FF')
                  .borderRadius(16)
                  .onClick(() => this.toggleGroup(group))
              }
            })
          }
          .listDirection(Axis.Horizontal)
          .width('100%')
          .height(36)
          .scrollBar(BarState.Off)
        }.width('100%')
      }

      Column({ space: 10 }) {
        Text('é€‰æ‹©å­¦ç”Ÿ (å¯å¤šé€‰)').fontSize(16).fontColor($r('app.color.text_secondary')).width('100%')
        if (this.students.length > 0) {
          Grid() {
            ForEach(this.students, (stu: Student) => {
              GridItem() {
                Text(stu.name)
                  .fontSize(14)
                  .fontColor(this.selectedStudentIds.includes(stu.id) ? Color.White : $r('app.color.text_primary'))
                  .fontWeight(this.selectedStudentIds.includes(stu.id) ? FontWeight.Bold : FontWeight.Normal)
                  .textAlign(TextAlign.Center)
                  .width('100%')
                  .padding({ top: 8, bottom: 8 })
                  .backgroundColor(this.selectedStudentIds.includes(stu.id) ? $r('app.color.picker_selected_blue') : $r('app.color.input_bg'))
                  .borderRadius(8)
                  .onClick(() => this.toggleStudent(stu.id))
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .columnsGap(10).rowsGap(10)
          .height(this.getGridHeight())
        } else {
          Text('æš‚æ— å­¦ç”Ÿæ¡£æ¡ˆï¼Œè¯·å»ã€å­¦ç”Ÿã€‘é¡µæ·»åŠ ').fontColor(Color.Red).fontSize(16)
        }
      }.width('100%')

      Column({ space: 5 }) {
        Text('ä¸Šè¯¾æ—¶é—´').fontSize(16).fontColor($r('app.color.text_secondary')).width('100%')
        Row() {
          TextPicker({ range: this.hours, selected: parseInt(this.selectedHour) })
            .onChange((value: string | string[]) => { this.selectedHour = value as string })
            .layoutWeight(1)
            .height(55)
            .disappearTextStyle({ color: $r('app.color.picker_disappear_text'), font: { size: 12 } })
            .textStyle({ color: $r('app.color.picker_normal_text'), font: { size: 16 } })
            .selectedTextStyle({ color: $r('app.color.picker_selected_blue'), font: { size: 20, weight: FontWeight.Bold } })
            .canLoop(true)

          Text(':')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .margin({ left: 10, right: 10 })
            .padding({ bottom: 4 })

          TextPicker({ range: this.minutes, selected: parseInt(this.selectedMinute) })
            .onChange((value: string | string[]) => { this.selectedMinute = value as string })
            .layoutWeight(1)
            .height(55)
            .disappearTextStyle({ color: $r('app.color.picker_disappear_text'), font: { size: 12 } })
            .textStyle({ color: $r('app.color.picker_normal_text'), font: { size: 16 } })
            .selectedTextStyle({ color: $r('app.color.picker_selected_blue'), font: { size: 20, weight: FontWeight.Bold } })
            .canLoop(true)
        }.width('100%')
      }.width('100%').margin({ top: 10 })

      TextInput({ placeholder: 'è¯¾ç¨‹å¤‡æ³¨ (é€‰å¡«)', text: this.note })
        .onChange(v => this.note = v)
        .backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_primary'))
        .fontSize(16).height(45).borderRadius(8)

      Row({ space: 20 }) {
        Button('å–æ¶ˆ').backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_secondary'))
          .fontSize(16).onClick(() => this.controller.close()).layoutWeight(1)

        Button(`ç¡®å®š (${this.selectedStudentIds.length})`)
          .backgroundColor($r('app.color.picker_selected_blue'))
          .fontSize(16)
          .onClick(() => {
            if (this.selectedStudentIds.length > 0) {
              this.confirm(
                this.selectedStudentIds,
                parseInt(this.selectedHour),
                parseInt(this.selectedMinute),
                this.note,
                this.currentGroupName
              );
            } else {
              AlertDialog.show({ message: 'è¯·è‡³å°‘é€‰æ‹©ä¸€åå­¦ç”Ÿ' })
            }
          }).layoutWeight(1)
      }
      .width('100%')
    }
    .padding(25)
    .backgroundColor($r('app.color.card_bg'))
    .width('100%')
    .borderRadius({
      topLeft: 24,
      topRight: 24,
      bottomLeft: 0,
      bottomRight: 0
    })
  }
}

// =======================
// 2. çµæ„Ÿå¼¹çª—
// =======================
@CustomDialog
struct AddInspirationDialog {
  controller: CustomDialogController
  confirm: (content: string) => void = () => {}
  @State content: string = ''

  build() {
    Column({ space: 20 }) {
      Text('è®°å½•çµæ„Ÿ').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 10 }).fontColor($r('app.color.text_primary'))
      TextArea({ placeholder: 'å†™ä¸‹æƒ³æ³•...', text: this.content }).onChange(v => this.content = v)
        .backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_primary')).fontSize(16).height(120).borderRadius(8)
      Row({ space: 20 }) {
        Button('å–æ¶ˆ').backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_secondary'))
          .fontSize(16).onClick(() => this.controller.close()).layoutWeight(1)
        Button('ä¿å­˜').backgroundColor('#FF9900')
          .fontSize(16).onClick(() => { if (this.content) { this.confirm(this.content); } }).layoutWeight(1)
      }.width('100%')
    }.padding(25).backgroundColor($r('app.color.card_bg')).borderRadius(16)
  }
}

// =======================
// 3. å¾…åŠæ·»åŠ å¼¹çª—
// =======================
@CustomDialog
struct AddTodoDialog {
  controller: CustomDialogController
  confirm: (content: string) => void = () => {}
  @State content: string = ''

  build() {
    Column({ space: 20 }) {
      Text('æ–°å»ºå¾…åŠ').fontSize(20).fontWeight(FontWeight.Bold).margin({ top: 10 }).fontColor($r('app.color.text_primary'))
      TextInput({ placeholder: 'è¦åšä»€ä¹ˆï¼Ÿ', text: this.content }).onChange(v => this.content = v)
        .backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_primary')).fontSize(16).height(50).borderRadius(8)
      Row({ space: 20 }) {
        Button('å–æ¶ˆ').backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_secondary'))
          .fontSize(16).onClick(() => this.controller.close()).layoutWeight(1)
        Button('ä¿å­˜').backgroundColor('#007DFF')
          .fontSize(16).onClick(() => { if (this.content) { this.confirm(this.content); } }).layoutWeight(1)
      }.width('100%')
    }.padding(25).backgroundColor($r('app.color.card_bg')).borderRadius(16)
  }
}

// =======================
// 4. å¾…åŠè¯¦æƒ…é¡µ
// =======================
@CustomDialog
struct TodoDetailDialog {
  controller: CustomDialogController
  currentDate: Date = new Date()
  onDataChanged: () => void = () => {}

  @State todos: TodoRecord[] = []
  addTodoCtrl: CustomDialogController | null = null

  async aboutToAppear() {
    await this.refreshLocalData();
  }

  async refreshLocalData() {
    const start = new Date(this.currentDate); start.setHours(0,0,0,0);
    const end = new Date(this.currentDate); end.setHours(23,59,59,999);
    this.todos = await dbHelper.getTodosByDate(start.getTime(), end.getTime());
    this.todos.sort((a, b) => a.isFinished - b.isFinished);
    this.onDataChanged();
  }

  getTitleDate(): string {
    return `${this.currentDate.getMonth() + 1}æœˆ${this.currentDate.getDate()}æ—¥`;
  }

  openAddTodo() {
    this.addTodoCtrl = new CustomDialogController({
      builder: AddTodoDialog({
        confirm: async (content) => {
          await dbHelper.addTodo(this.currentDate.getTime(), content);
          this.refreshLocalData();
          if (this.addTodoCtrl) this.addTodoCtrl.close();
        }
      }),
      alignment: DialogAlignment.Bottom, offset: { dx: 0, dy: -20 }
    });
    this.addTodoCtrl.open();
  }

  async toggleFinish(todo: TodoRecord) {
    const newStatus = todo.isFinished === 1 ? 0 : 1;
    await dbHelper.updateTodoStatus(todo.id, newStatus);
    this.refreshLocalData();
  }

  async handleDelete(id: number) {
    await dbHelper.deleteTodo(id);
    this.refreshLocalData();
  }

  @Builder SwipeMenu(id: number) {
    Row() {
      Button({ type: ButtonType.Circle }) {
        SymbolGlyph($r('sys.symbol.trash')).fontSize(24).fontColor([Color.White])
      }
      .width(40).height(40).backgroundColor(Color.Red)
      .onClick(() => this.handleDelete(id))
    }.width(60).justifyContent(FlexAlign.Center)
  }

  @Builder AddTodoButton() {
    Button() {
      Row({ space: 0 }) {
        Text('æ–°å»º').fontSize(14).fontWeight(FontWeight.Bold).fontColor(Color.White)
      }
    }
    .height(36)
    .padding({ left: 12, right: 12 })
    .backgroundColor('#007DFF')
    .borderRadius(18)
    .shadow({ radius: 8, color: '#40007DFF', offsetY: 3 })
    .onClick(() => this.openAddTodo())
  }

  build() {
    Column() {
      Row() {
        Row() {
          Text(this.getTitleDate()).fontSize(24).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
          Text(' / å¾…åŠäº‹é¡¹').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ left: 8, bottom: 2 })
        }.alignItems(VerticalAlign.Bottom)
        Blank()
        this.AddTodoButton()
      }.width('100%').margin({ top: 10, bottom: 20 })

      if (this.todos.length === 0) {
        Column() {
          Text('ä»Šå¤©æ²¡æœ‰å¾…åŠä»»åŠ¡').fontColor($r('app.color.text_secondary')).fontSize(14)
        }
        .width('100%').height(200).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 10 }) {
          ForEach(this.todos, (item: TodoRecord) => {
            ListItem() {
              Row() {
                Stack({ alignContent: Alignment.Center }) {
                  Circle({ width: 24, height: 24 })
                    .fill(item.isFinished ? '#007DFF' : 'transparent')
                    .stroke(item.isFinished ? '#007DFF' : '#007DFF')
                    .strokeWidth(2)
                  if (item.isFinished) {
                    SymbolGlyph($r('sys.symbol.checkmark')).fontSize(14).fontColor([Color.White])
                  }
                }
                .onClick(() => this.toggleFinish(item))
                .margin({ right: 15 })

                Text(item.content)
                  .fontSize(16)
                  .fontColor(item.isFinished ? $r('app.color.text_secondary') : $r('app.color.text_primary'))
                  .decoration({ type: item.isFinished ? TextDecorationType.LineThrough : TextDecorationType.None, color: $r('app.color.text_secondary') })
                  .layoutWeight(1)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .width('100%').padding(15).backgroundColor($r('app.color.input_bg')).borderRadius(12)
            }
            .swipeAction({ end: this.SwipeMenu(item.id) })
          })
        }
        .width('100%').height(350).scrollBar(BarState.Off)
      }
    }
    .padding(25).backgroundColor($r('app.color.card_bg'))
    .borderRadius({ topLeft: 24, topRight: 24, bottomLeft: 0, bottomRight: 0 }).width('100%')
  }
}

// =======================
// 5. è¯¦æƒ…é¡µå¼¹çª— (æ—¥ç¨‹æ¦‚è§ˆ)
// =======================
interface DisplayGroup {
  type: 'group';
  date: number;
  records: CourseRecord[];
}

type ScheduleItem = DisplayGroup | InspirationRecord;

@CustomDialog
struct DailyDetailDialog {
  controller: CustomDialogController
  currentDate: Date = new Date()
  onDataChanged: () => void = () => {}

  @State items: ScheduleItem[] = []
  @State allStudents: Student[] = []
  @State allGroups: StudentGroup[] = []

  addCourseCtrl: CustomDialogController | null = null
  addInspCtrl: CustomDialogController | null = null

  async aboutToAppear() {
    this.allStudents = await dbHelper.getStudents();
    this.generateGroupsFromStudents();
    await this.refreshLocalData();
  }

  generateGroupsFromStudents() {
    const groupMap = new Map<string, number[]>();
    this.allStudents.forEach(stu => {
      const gName = stu.groupName || 'é»˜è®¤åˆ†ç»„';
      if (!groupMap.has(gName)) {
        groupMap.set(gName, []);
      }
      groupMap.get(gName)?.push(stu.id);
    });

    const groups: StudentGroup[] = [];
    if (this.allStudents.length > 1) {
      groups.push({
        name: 'å…¨å‘˜',
        studentIds: this.allStudents.map(s => s.id)
      });
    }

    groupMap.forEach((ids, name) => {
      if (ids.length > 0) {
        groups.push({ name: name, studentIds: ids });
      }
    });

    this.allGroups = groups;
  }

  async refreshLocalData() {
    const start = new Date(this.currentDate); start.setHours(0,0,0,0);
    const end = new Date(this.currentDate); end.setHours(23,59,59,999);

    const courses = await dbHelper.getCoursesByDate(start.getTime(), end.getTime());
    const insps = await dbHelper.getInspirationsByDate(start.getTime(), end.getTime());

    const groupsMap = new Map<number, CourseRecord[]>();
    courses.forEach(c => {
      if (!groupsMap.has(c.date)) {
        groupsMap.set(c.date, []);
      }
      groupsMap.get(c.date)?.push(c);
    });

    const displayGroups: DisplayGroup[] = [];
    groupsMap.forEach((recs, date) => {
      displayGroups.push({
        type: 'group',
        date: date,
        records: recs
      });
    });

    this.items = [...displayGroups, ...insps].sort((a, b) => a.date - b.date) as ScheduleItem[];
    this.onDataChanged();
  }

  formatTime(timestamp: number): string {
    const d = new Date(timestamp);
    return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
  }

  getTitleDate(): string {
    return `${this.currentDate.getMonth() + 1}æœˆ${this.currentDate.getDate()}æ—¥`;
  }

  isGroupFinished(group: DisplayGroup): boolean {
    return group.records.every(r => r.isFinished === 1);
  }

  getStudentNames(group: DisplayGroup): string {
    return group.records.map(r => r.studentName).join('ã€');
  }

  async finishGroup(group: DisplayGroup) {
    for (const record of group.records) {
      if (record.isFinished === 0) {
        await dbHelper.finishCourse(record.id, record.studentId);
      }
    }
    this.refreshLocalData();
  }

  async deleteGroup(group: DisplayGroup) {
    for (const record of group.records) {
      await dbHelper.deleteCourse(record.id);
    }
    this.refreshLocalData();
  }

  async deleteInsp(id: number) {
    await dbHelper.deleteInspiration(id);
    this.refreshLocalData();
  }

  openAddCourse() {
    this.addCourseCtrl = new CustomDialogController({
      builder: AddCourseDialog({
        students: this.allStudents,
        groups: this.allGroups,
        confirm: async (sids, h, m, note, groupName) => {
          const d = new Date(this.currentDate);
          d.setHours(h, m, 0, 0);

          for(const sid of sids) await dbHelper.addCourse(sid, d.getTime(), note);

          let title = '';
          if (groupName && groupName !== 'å…¨å‘˜' && groupName !== 'é»˜è®¤åˆ†ç»„') {
            title = groupName;
          } else if (groupName === 'å…¨å‘˜') {
            title = 'å…¨å‘˜è¯¾ç¨‹';
          } else {
            const targetStudents = this.allStudents.filter(s => sids.includes(s.id));
            const names = targetStudents.map(s => s.name).join('ã€');
            title = names ? names : 'è¯¾ç¨‹æé†’';
          }

          await NotificationHelper.addCourseReminder(title, d.getTime());

          this.refreshLocalData();
          if (this.addCourseCtrl) this.addCourseCtrl.close();
        }
      }),
      alignment: DialogAlignment.Bottom,
      customStyle: true,
      offset: { dx: 0, dy: 0 }
    });
    this.addCourseCtrl.open();
  }

  openAddInsp() {
    this.addInspCtrl = new CustomDialogController({
      builder: AddInspirationDialog({
        confirm: async (content) => {
          const d = new Date(this.currentDate);
          await dbHelper.addInspiration(d.getTime(), content);
          this.refreshLocalData();
          if (this.addInspCtrl) this.addInspCtrl.close();
        }
      }),
      alignment: DialogAlignment.Bottom, offset: { dx: 0, dy: -20 }
    });
    this.addInspCtrl.open();
  }

  @Builder SwipeMenu(item: ScheduleItem) {
    Row() {
      Button({ type: ButtonType.Circle }) {
        SymbolGlyph($r('sys.symbol.trash')).fontSize(24).fontColor([Color.White])
      }
      .width(40).height(40).backgroundColor(Color.Red)
      .onClick(() => {
        if (item.type === 'group') {
          this.deleteGroup(item as DisplayGroup);
        } else {
          this.deleteInsp((item as InspirationRecord).id);
        }
      })
    }
    .width(60).justifyContent(FlexAlign.Center)
  }

  @Builder AddCourseInspButton(title: string, icon: Resource, color: string, action: () => void) {
    Button() {
      Row() {
        SymbolGlyph(icon).fontSize(20).fontColor([color]).margin({ right: 8 });
        Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor(color)
      }
    }
    .layoutWeight(1).height(50).backgroundColor($r('app.color.input_bg')).borderRadius(12).onClick(action)
  }

  build() {
    Column() {
      Row() {
        Row() {
          Text(this.getTitleDate()).fontSize(24).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
          Text(' / æ—¥ç¨‹æ¦‚è§ˆ').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ left: 8, bottom: 2 })
        }.alignItems(VerticalAlign.Bottom)
        Blank()
        Button('æ”¶èµ·').fontSize(12).height(28).backgroundColor('#007DFF').fontColor(Color.White)
          .onClick(() => this.controller.close())
      }.width('100%').margin({ top: 10, bottom: 20 })

      Row({ space: 15 }) {
        this.AddCourseInspButton('æ’ä¸€èŠ‚è¯¾', $r('sys.symbol.calendar'), '#007DFF', (): void => this.openAddCourse())
        this.AddCourseInspButton('è®°ä¸ªçµæ„Ÿ', $r('sys.symbol.lightbulb'), '#FF9900', (): void => this.openAddInsp())
      }.width('100%').margin({ bottom: 20 })

      if (this.items.length === 0) {
        Column() { Text('æš‚æ— å®‰æ’').fontColor($r('app.color.text_secondary')).fontSize(14) }.width('100%').height(100).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 15 }) {
          ForEach(this.items, (item: ScheduleItem) => {
            ListItem() {
              Row() {
                Divider().vertical(true).height(30)
                  .color(item.type === 'group' ? '#007DFF' : '#FF9900')
                  .strokeWidth(4).lineCap(LineCapStyle.Round).margin({ right: 15 })

                if (item.type === 'group') {
                  Row() {
                    Column() {
                      Text('è¯¾ç¨‹').fontSize(16).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
                      Text(this.formatTime(item.date)).fontSize(12).fontColor($r('app.color.text_secondary')).margin({ top: 2 })
                    }.width(60).alignItems(HorizontalAlign.Start)

                    Text(this.getStudentNames(item as DisplayGroup))
                      .fontSize(16).fontWeight(FontWeight.Medium).fontColor($r('app.color.text_primary'))
                      .layoutWeight(1).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).margin({ left: 10, right: 10 })

                    Row() {
                      if (this.isGroupFinished(item as DisplayGroup)) {
                        Text('å·²æ¶ˆè¯¾').fontSize(12).fontColor('#00AA00').backgroundColor('#E0F8E0').padding({left:6, right:6, top:2, bottom:2}).borderRadius(4)
                      } else {
                        Button('æ¶ˆè¯¾')
                          .fontSize(12).height(24).padding({ left: 8, right: 8 }).backgroundColor('#007DFF')
                          .onClick(() => this.finishGroup(item as DisplayGroup))
                      }
                    }.flexShrink(0).margin({ left: 0 })
                  }.layoutWeight(1)
                } else {
                  Row() {
                    Column() {
                      Text('çµæ„Ÿç¬”è®°').fontSize(16).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
                    }.width(80).alignItems(HorizontalAlign.Start)

                    Text((item as InspirationRecord).content)
                      .fontSize(14).fontColor($r('app.color.text_secondary'))
                      .layoutWeight(1).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis }).margin({ left: 5 })
                  }.layoutWeight(1)
                }
              }
              .width('100%').padding(15).backgroundColor($r('app.color.input_bg')).borderRadius(12)
            }
            .swipeAction({ end: this.SwipeMenu(item) })
          })
        }
        .width('100%').height(300).scrollBar(BarState.Off)
      }
    }
    .padding(25).backgroundColor($r('app.color.card_bg'))
    .borderRadius({ topLeft: 24, topRight: 24, bottomLeft: 0, bottomRight: 0 }).width('100%')
  }
}

// =======================
// 6. ä¸»é¡µé¢ (ä¸»å…¥å£)
// =======================
@Component
export struct CalendarPage {
  @State currentYear: number = new Date().getFullYear();
  @State currentMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State daysInMonth: number[] = [];
  @State startWeekDay: number = 0;
  @State courseMarkers: number[] = [];
  @State inspMarkers: number[] = [];
  @State todayCoursesCount: number = 0;
  @State todayTodosCount: number = 0;

  @StorageProp('AppGlobalUpdate') @Watch('refreshData') updateSignal: number = 0;

  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ–°å¢ã€‘ç›‘å¬å¿«æ·æ–¹å¼åŠ¨ä½œ ğŸ‘‡ğŸ‘‡ğŸ‘‡
  @StorageLink('GlobalShortcutAction') @Watch('onShortcutTrigger') shortcutAction: string = '';

  detailController: CustomDialogController | null = null;
  todoController: CustomDialogController | null = null;

  // ä¸´æ—¶å­˜å‚¨æ’è¯¾ç”¨çš„ Controllerï¼Œé¿å…ç±»å‹é”™è¯¯
  directAddCourseController: CustomDialogController | null = null;

  async aboutToAppear(): Promise<void> {
    let context = getContext(this) as common.UIAbilityContext;
    await dbHelper.initDB(context);
    this.initCalendar();
    this.refreshData();
    // å…³é”®ï¼šåˆå§‹åŒ–æ—¶æ£€æŸ¥å¿«æ·æ–¹å¼
    this.onShortcutTrigger();
  }

  onPageShow() {
    this.refreshData();
    // å…³é”®ï¼šé¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥å¿«æ·æ–¹å¼ (çƒ­å¯åŠ¨)
    this.onShortcutTrigger();
  }

  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€å…³é”®é€»è¾‘ã€‘å¤„ç†å¿«æ·æ–¹å¼è§¦å‘ ğŸ‘‡ğŸ‘‡ğŸ‘‡
  async onShortcutTrigger() {
    if (!this.shortcutAction) return;

    // åªæœ‰åŠ¨ä½œä¸º action_add_course æ—¶æ‰å“åº” (æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»åŒ¹é… shortcuts_config.json çš„ action)
    if (this.shortcutAction === 'action_add_course') {
      console.info('CalendarPage å“åº”å¿«æ·æ–¹å¼: æ’ä¸€èŠ‚è¯¾');

      // å»¶è¿Ÿ 200msï¼Œç¡®ä¿ Tab åˆ‡æ¢åŠ¨ç”»å®Œæˆ
      setTimeout(async () => {
        // 1. è·å–æ‰€æœ‰å­¦ç”Ÿæ•°æ® (å› ä¸º AddCourseDialog éœ€è¦æ•°æ®)
        const students = await dbHelper.getStudents();

        // 2. ç”Ÿæˆç®€å•åˆ†ç»„
        const groups: StudentGroup[] = [];
        // ç®€å•åˆ†ç»„é€»è¾‘ï¼šæŒ‰ student.groupName åˆ†ç»„
        const groupMap = new Map<string, number[]>();
        students.forEach(stu => {
          const gName = stu.groupName || 'é»˜è®¤åˆ†ç»„';
          if (!groupMap.has(gName)) groupMap.set(gName, []);
          groupMap.get(gName)?.push(stu.id);
        });
        if (students.length > 1) {
          groups.push({ name: 'å…¨å‘˜', studentIds: students.map(s => s.id) });
        }
        groupMap.forEach((ids, name) => {
          if (ids.length > 0) groups.push({ name: name, studentIds: ids });
        });

        // 3. ç›´æ¥æ‰“å¼€æ’è¯¾å¼¹çª— (AddCourseDialog)
        this.directAddCourseController = new CustomDialogController({
          builder: AddCourseDialog({
            students: students,
            groups: groups,
            confirm: async (sids, h, m, note, groupName) => {
              // æ’è¯¾ä¿å­˜é€»è¾‘
              const d = new Date(); // é»˜è®¤ä¸ºä»Šå¤©
              d.setHours(h, m, 0, 0);

              for(const sid of sids) await dbHelper.addCourse(sid, d.getTime(), note);

              // é€šçŸ¥é€»è¾‘
              let title = '';
              if (groupName && groupName !== 'å…¨å‘˜' && groupName !== 'é»˜è®¤åˆ†ç»„') title = groupName;
              else if (groupName === 'å…¨å‘˜') title = 'å…¨å‘˜è¯¾ç¨‹';
              else {
                const targetStudents = students.filter(s => sids.includes(s.id));
                const names = targetStudents.map(s => s.name).join('ã€');
                title = names ? names : 'è¯¾ç¨‹æé†’';
              }
              await NotificationHelper.addCourseReminder(title, d.getTime());

              // åˆ·æ–°é¡µé¢æ•°æ®
              this.refreshData();
              if (this.directAddCourseController) this.directAddCourseController.close();
            }
          }),
          alignment: DialogAlignment.Bottom,
          customStyle: true,
          offset: { dx: 0, dy: 0 }
        });
        this.directAddCourseController.open();

        // 4. æ¸…ç©ºå…¨å±€åŠ¨ä½œï¼Œé˜²æ­¢é‡å¤è§¦å‘
        AppStorage.setOrCreate('GlobalShortcutAction', '');
        this.shortcutAction = ''; // æœ¬åœ°çŠ¶æ€ä¹Ÿæ¸…ç©º

      }, 200);
    }
  }

  initCalendar(): void {
    const date = new Date(this.currentYear, this.currentMonth - 1, 1);
    this.startWeekDay = date.getDay();
    const lastDay = new Date(this.currentYear, this.currentMonth, 0).getDate();
    this.daysInMonth = [];
    for(let i=1; i<=lastDay; i++) this.daysInMonth.push(i);
  }

  async refreshData(): Promise<void> {
    const markers = await dbHelper.getMonthMarkers(this.currentYear, this.currentMonth);
    this.courseMarkers = markers.courses;
    this.inspMarkers = markers.inspirations;

    const selDate = new Date(this.currentYear, this.currentMonth - 1, this.selectedDay);
    const start = new Date(selDate); start.setHours(0,0,0,0);
    const end = new Date(selDate); end.setHours(23,59,59,999);

    const courses = await dbHelper.getCoursesByDate(start.getTime(), end.getTime());
    const insps = await dbHelper.getInspirationsByDate(start.getTime(), end.getTime());
    const todos = await dbHelper.getTodosByDate(start.getTime(), end.getTime());

    this.todayCoursesCount = courses.length + insps.length;
    this.todayTodosCount = todos.filter(t => t.isFinished === 0).length;
  }

  handleMonthChange(year: number, month: number): void {
    this.currentYear = year;
    this.currentMonth = month;
    const lastDayOfNewMonth = new Date(year, month, 0).getDate();
    this.selectedDay = Math.min(this.selectedDay, lastDayOfNewMonth);

    this.initCalendar();
    this.refreshData();
  }

  handlePrevMonth(): void {
    let newYear = this.currentYear;
    let newMonth = this.currentMonth - 1;
    if (newMonth === 0) { newYear--; newMonth = 12; }
    this.handleMonthChange(newYear, newMonth);
  }

  handleNextMonth(): void {
    let newYear = this.currentYear;
    let newMonth = this.currentMonth + 1;
    if (newMonth === 13) { newYear++; newMonth = 1; }
    this.handleMonthChange(newYear, newMonth);
  }

  onDayClick(day: number): void {
    this.selectedDay = day;
    this.refreshData().then(() => {
      this.openDetailDialog();
    });
  }

  openDetailDialog(): void {
    this.detailController = new CustomDialogController({
      builder: DailyDetailDialog({
        currentDate: new Date(this.currentYear, this.currentMonth - 1, this.selectedDay),
        onDataChanged: () => {
          this.refreshData();
        }
      }),
      alignment: DialogAlignment.Bottom,
      customStyle: true,
      autoCancel: true
    });
    this.detailController.open();
  }

  openTodoDialog(): void {
    this.todoController = new CustomDialogController({
      builder: TodoDetailDialog({
        currentDate: new Date(this.currentYear, this.currentMonth - 1, this.selectedDay),
        onDataChanged: () => {
          this.refreshData();
        }
      }),
      alignment: DialogAlignment.Bottom,
      customStyle: true,
      autoCancel: true
    });
    this.todoController.open();
  }

  @Builder OverviewCard() {
    Row() {
      Column() {
        Text('ä»Šæ—¥æ¦‚è§ˆ').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#007DFF')
        Text(`${this.todayCoursesCount} é¡¹æ—¥ç¨‹`).fontSize(14).fontColor($r('app.color.text_primary')).margin({ top: 5 })
      }.alignItems(HorizontalAlign.Start)
      Blank()
      SymbolGlyph($r('sys.symbol.calendar')).fontSize(32).fontColor(['#007DFF'])
    }.width('100%').padding(20).backgroundColor($r('app.color.card_bg')).borderRadius(20)
    .onClick(() => {
      const today = new Date().getDate();
      this.selectedDay = today;
      this.openDetailDialog();
    })
  }

  @Builder TodoCard() {
    Row() {
      Column() {
        Text('ä»Šæ—¥å¾…åŠ').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#007DFF')
        Text(`${this.todayTodosCount} ä¸ªæœªå®Œæˆ`).fontSize(14).fontColor($r('app.color.text_primary')).margin({ top: 5 })
      }.alignItems(HorizontalAlign.Start)
      Blank()
      SymbolGlyph($r('sys.symbol.doc_plaintext')).fontSize(32).fontColor(['#007DFF'])
    }.width('100%').padding(20).backgroundColor($r('app.color.card_bg')).borderRadius(20)
    .onClick(() => { this.openTodoDialog(); })
  }

  build() {
    Column() {
      Text("è¯¾æ—¶è®°").fontSize(24).fontWeight(FontWeight.Bold).width('100%').textAlign(TextAlign.Center) .padding({ top: 56, bottom: 10 }).fontColor($r('app.color.text_primary')).backgroundColor($r('app.color.page_bg'))

      Scroll() {
        Column({ space: 15 }) {
          // 1. æ—¥å†å¡ç‰‡
          Column() {
            Row() {
              SymbolGlyph($r('sys.symbol.chevron_left')).fontSize(20).fontColor([$r('app.color.text_secondary')]).onClick(() => this.handlePrevMonth()).padding(10)
              Text(`${this.currentYear}å¹´ ${this.currentMonth}æœˆ`).fontSize(18).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary')).margin({ left: 10, right: 10 })
              SymbolGlyph($r('sys.symbol.chevron_right')).fontSize(20).fontColor([$r('app.color.text_secondary')]).onClick(() => this.handleNextMonth()).padding(10)
            }.width('100%').justifyContent(FlexAlign.Center).margin({ bottom: 15 })

            Row() {
              ForEach(['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'], (d: string) => {
                Text(d).fontSize(14).fontColor($r('app.color.text_secondary')).textAlign(TextAlign.Center).layoutWeight(1)
              })
            }.width('100%').margin({ bottom: 10 })

            Grid() {
              ForEach(Array(this.startWeekDay).fill(0), () => { GridItem() })
              ForEach(this.daysInMonth, (day: number) => {
                GridItem() {
                  Column() {
                    Text(day.toString())
                      .fontSize(16).fontWeight(this.selectedDay === day ? FontWeight.Bold : FontWeight.Normal)
                      .fontColor(this.selectedDay === day ? Color.White : $r('app.color.text_primary'))
                      .width(36).height(36).textAlign(TextAlign.Center)
                      .backgroundColor(this.selectedDay === day ? '#007DFF' : 'transparent').borderRadius(18)
                    Row({ space: 3 }) {
                      if (this.courseMarkers.includes(day)) Circle({ width: 4, height: 4 }).fill('#007DFF')
                      if (this.inspMarkers.includes(day)) Circle({ width: 4, height: 4 }).fill('#FF9900')
                    }.margin({ top: 4 }).height(4)
                  }.width('100%').height(50).justifyContent(FlexAlign.Start).onClick(() => this.onDayClick(day))
                }
              })
            }.columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr').rowsGap(5).height(300)
          }
          .width('100%').padding(15).backgroundColor($r('app.color.card_bg')).borderRadius(24)

          // 2. ä»Šæ—¥æ¦‚è§ˆå¡ç‰‡
          this.OverviewCard()

          // 3. ä»Šæ—¥å¾…åŠå¡ç‰‡
          this.TodoCard()

        }.padding({ left: 15, right: 15, bottom: 20 })
      }.scrollBar(BarState.Off).align(Alignment.Top).height('100%')
    }.width('100%').height('100%').backgroundColor($r('app.color.page_bg'))
  }
}
