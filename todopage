// entry/src/main/ets/pages/TodoPage.ets
import { dbHelper, TodoRecord } from '../db/DBHelper';
import { common } from '@kit.AbilityKit';
import { motion } from '@kit.MultimodalAwarenessKit';
import { curves } from '@kit.ArkUI';
import { NotificationHelper } from '../utils/NotificationHelper';

// =======================
// [è‡ªå®šä¹‰ç»„ä»¶] å¾…åŠå¡ç‰‡
// =======================
@Component
struct TodoItemCard {
  @Prop item: TodoRecord

  onToggle: () => void = () => {}
  onDelete: () => void = () => {}

  @Builder SwipeMenu() {
    Row() {
      Column() {
        SymbolGlyph($r('sys.symbol.trash'))
          .fontSize(22)
          .fontColor([Color.White])
      }
      .width(44)
      .height(44)
      .borderRadius(22)
      .backgroundColor(Color.Red)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .shadow({ radius: 5, color: '#20FF0000', offsetY: 2 })
      .onClick(() => {
        this.onDelete()
      })
    }
    .width(80)
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  build() {
    ListItem() {
      Row() {
        Stack({ alignContent: Alignment.Center }) {
          Circle({ width: 24, height: 24 })
            .fill(this.item.isFinished ? $r('app.color.accent') : 'transparent')
            .stroke(this.item.isFinished ? $r('app.color.accent') : $r('app.color.text_secondary'))
            .strokeWidth(2)

          if (this.item.isFinished) {
            SymbolGlyph($r('sys.symbol.checkmark'))
              .fontSize(14)
              .fontColor([Color.White])
          }
        }
        .width(30)
        .height(30)
        .alignContent(Alignment.Center)
        .margin({ right: 15 })

        Text(this.item.content)
          .fontSize(16)
          .fontColor(this.item.isFinished ? $r('app.color.text_secondary') : $r('app.color.text_primary'))
          .decoration({
            type: this.item.isFinished ? TextDecorationType.LineThrough : TextDecorationType.None,
            color: $r('app.color.text_secondary')
          })
          .layoutWeight(1)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .padding(15)
      .backgroundColor($r('app.color.card_bg'))
      .borderRadius(16)
    }
    .onClick(() => { this.onToggle() })
    .swipeAction({ end: this.SwipeMenu() })
  }
}

// =======================
// 1. æ–°å»ºå¾…åŠå¼¹çª—
// =======================
@CustomDialog
struct AddTodoDialog {
  controller: CustomDialogController
  confirm: (content: string) => void = () => {}
  @State content: string = ''
  @State confirmButtonScale: number = 1.0;

  build() {
    Column({ space: 20 }) {
      Text('æ–°å»ºå¾…åŠ').fontSize(20).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary')).width('100%').textAlign(TextAlign.Start).margin({ top: 10 })
      TextInput({ placeholder: 'è¦åšä»€ä¹ˆï¼Ÿ', text: this.content }).onChange(v => this.content = v)
        .backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_primary')).fontSize(16).height(50).borderRadius(8)
      Row({ space: 20 }) {
        Button('å–æ¶ˆ').backgroundColor($r('app.color.input_bg')).fontColor($r('app.color.text_secondary'))
          .fontSize(16).onClick(() => { if(this.controller) this.controller.close() }).layoutWeight(1)

        Button('ä¿å­˜').backgroundColor($r('app.color.accent'))
          .fontSize(16).onClick(() => { if (this.content) { this.confirm(this.content); if (this.controller) this.controller.close() } }).layoutWeight(1)
          .scale({ x: this.confirmButtonScale, y: this.confirmButtonScale })
          .onTouch((event: TouchEvent) => {
            animateTo({ duration: 100 }, () => {
              if (event.type === TouchType.Down) {
                this.confirmButtonScale = 0.9;
              } else if (event.type === TouchType.Up) {
                this.confirmButtonScale = 1.0;
              }
            });
          })
      }.width('100%')
    }.padding(25).backgroundColor($r('app.color.card_bg')).borderRadius(16)
  }
}

// =======================
// 2. å¾…åŠæ¸…å•ä¸»é¡µé¢
// =======================
@Entry
@Component
export struct TodoPage {
  @State unfinishedList: TodoRecord[] = []
  @State finishedList: TodoRecord[] = []
  @State selectedDate: Date = new Date()
  @State totalCount: number = 0
  @State finishedCount: number = 0

  // æ¡æŒçŠ¶æ€ (é»˜è®¤å³æ‰‹: true)
  @State isRightHand: boolean = true

  // åŠ¨ç”»æ§åˆ¶çŠ¶æ€
  @State opacityValue: number = 1;
  @State offsetX: number = 0;

  // é˜²æŠ–å®šæ—¶å™¨é…ç½®
  private motionTimerId: number = -1;
  private readonly DEBOUNCE_DELAY: number = 200; // 200ms é˜²æŠ–

  @StorageProp('AppGlobalUpdate') @Watch('refreshData') updateSignal: number = 0;

  // ç›‘å¬å¿«æ·æ–¹å¼åŠ¨ä½œ
  @StorageLink('GlobalShortcutAction') @Watch('onShortcutTrigger') shortcutAction: string = '';

  // ã€å…³é”®ã€‘é˜²æ­¢é‡å¤è§¦å‘å¼¹çª—çš„é”
  private isProcessingShortcut: boolean = false;

  addController: CustomDialogController | null = null
  @State floatingButtonScale: number = 1.0;

  async aboutToAppear() {
    let context = getContext(this) as common.UIAbilityContext;
    await dbHelper.initDB(context);
    this.refreshData();
    // å¯åŠ¨ Motion ç›‘å¬
    this.startMotion();
    // åˆå§‹åŒ–æ£€æŸ¥å¿«æ·æ–¹å¼ (å†·å¯åŠ¨)
    this.onShortcutTrigger();
  }

  onPageShow() {
    this.refreshData();
    // é¡µé¢æ˜¾ç¤ºæ£€æŸ¥å¿«æ·æ–¹å¼ (çƒ­å¯åŠ¨/Tabåˆ‡æ¢)
    this.onShortcutTrigger();
  }

  aboutToDisappear() { this.stopMotion(); }

  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¤„ç†å¿«æ·æ–¹å¼è§¦å‘ï¼Œå¢åŠ é˜²æŠ–é” ğŸ‘‡ğŸ‘‡ğŸ‘‡
  onShortcutTrigger() {
    // 1. å¦‚æœä¸æ˜¯æœ¬é¡µé¢çš„åŠ¨ä½œï¼Œå¿½ç•¥
    if (this.shortcutAction !== 'action_add_todo') return;

    // 2. å¦‚æœæ­£åœ¨å¤„ç†ä¸­ï¼ˆé”ä½çŠ¶æ€ï¼‰ï¼Œå¿½ç•¥ -> é˜²æ­¢äºŒæ¬¡å¼¹çª—
    if (this.isProcessingShortcut) return;

    console.info('TodoPage å“åº”å¿«æ·æ–¹å¼: æ‰“å¼€æ–°å»ºå¾…åŠå¼¹çª—');

    // 3. ä¸Šé”
    this.isProcessingShortcut = true;

    // å»¶è¿Ÿ 200msï¼Œç­‰å¾… Index é¡µé¢åˆ‡æ¢åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      // æ‰“å¼€å¼¹çª—
      this.openAddTodo();

      // æ¸…ç©ºå…¨å±€åŠ¨ä½œ
      AppStorage.setOrCreate('GlobalShortcutAction', '');

      // 4. è§£é” (ä»»åŠ¡å®Œæˆ)
      this.isProcessingShortcut = false;
    }, 200);
  }
  // ğŸ‘†ğŸ‘†ğŸ‘†

  // ==========================================
  // ã€æ ¸å¿ƒåŠŸèƒ½ã€‘ç›‘å¬æ¡æŒå§¿åŠ¿ (é˜²æŠ– + å¼¹ç°§åŠ¨ç”»)
  // ==========================================
  startMotion() {
    try {
      motion.on('holdingHandChanged', (data: number) => {
        // data=2 è§†ä¸ºå³æ‰‹å¸ƒå±€
        let targetIsRightHand: boolean = (data === 2);

        if (targetIsRightHand !== this.isRightHand) {

          // å¦‚æœæœ‰æ­£åœ¨ç­‰å¾…çš„è®¡æ—¶å™¨ï¼Œæ¸…é™¤å®ƒï¼ˆé˜²æŠ–æ ¸å¿ƒï¼‰
          if (this.motionTimerId !== -1) {
            clearTimeout(this.motionTimerId);
          }

          // å¼€å¯æ–°è®¡æ—¶å™¨
          this.motionTimerId = setTimeout(() => {

            let exitOffsetX = this.isRightHand ? 200 : -200;

            // 1. æ»‘å‡ºé˜¶æ®µ (æ™®é€šæ›²çº¿)
            animateTo({ duration: 250, curve: Curve.EaseIn, onFinish: () => {

              // åˆ‡æ¢å¸ƒå±€æ–¹å‘
              this.isRightHand = targetIsRightHand;
              // ç¬é—´ç§»åŠ¨åˆ°å¦ä¸€ä¾§å±å¹•å¤–
              this.offsetX = targetIsRightHand ? 200 : -200;

              // 2. æ»‘å…¥é˜¶æ®µ (å¼¹ç°§æ›²çº¿)
              animateTo({
                curve: curves.springCurve(0, 1, 228, 30)
              }, () => {
                this.offsetX = 0;
                this.opacityValue = 1;
              });

            } }, () => {
              this.offsetX = exitOffsetX;
              this.opacityValue = 0;
            });

            this.motionTimerId = -1;

          }, this.DEBOUNCE_DELAY);

        } else {
          // çŠ¶æ€æœªå˜ï¼Œå–æ¶ˆå¯èƒ½çš„è®¡æ—¶å™¨
          if (this.motionTimerId !== -1) {
            clearTimeout(this.motionTimerId);
            this.motionTimerId = -1;
          }
        }
      });
    } catch (err) {
      console.error('Motion ç›‘å¬å¤±è´¥: ' + JSON.stringify(err));
    }
  }

  stopMotion() {
    try {
      motion.off('holdingHandChanged');
      if (this.motionTimerId !== -1) {
        clearTimeout(this.motionTimerId);
      }
    } catch (err) {}
  }

  // ==========================================
  // æ•°æ®åˆ·æ–°ä¸é€šçŸ¥æ›´æ–°
  // ==========================================
  async refreshData() {
    const start = new Date(this.selectedDate); start.setHours(0,0,0,0);
    const end = new Date(this.selectedDate); end.setHours(23,59,59,999);

    const allTodos = await dbHelper.getTodosByDate(start.getTime(), end.getTime());
    this.unfinishedList = allTodos.filter(t => t.isFinished === 0);
    this.finishedList = allTodos.filter(t => t.isFinished === 1);
    this.totalCount = allTodos.length;
    this.finishedCount = this.finishedList.length;

    // å¦‚æœæ˜¯æŸ¥çœ‹â€œä»Šå¤©â€ï¼Œåˆ™æ›´æ–°æ™šä¸Šçš„è¿›åº¦é€šçŸ¥
    if (this.isToday(this.selectedDate)) {
      NotificationHelper.updateDailySummary(this.finishedCount, this.totalCount);
    }
  }

  // è¾…åŠ©æ–¹æ³•ï¼šåˆ¤æ–­æ—¥æœŸæ˜¯å¦æ˜¯ä»Šå¤©
  isToday(date: Date): boolean {
    const today = new Date();
    return date.getDate() === today.getDate() &&
      date.getMonth() === today.getMonth() &&
      date.getFullYear() === today.getFullYear();
  }

  openDatePicker() { DatePickerDialog.show({ start: new Date("2020-1-1"), end: new Date("2100-12-31"), selected: this.selectedDate, onAccept: (value: DatePickerResult) => { if (value.year !== undefined && value.month !== undefined && value.day !== undefined) { this.selectedDate = new Date(value.year, value.month, value.day); this.refreshData(); } } }); }

  openAddTodo() {
    this.addController = new CustomDialogController({
      builder: AddTodoDialog({
        confirm: async (content) => {
          const targetTime = new Date(this.selectedDate);
          const now = new Date();
          targetTime.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
          await dbHelper.addTodo(targetTime.getTime(), content);
          this.refreshData();
        }
      }),
      alignment: DialogAlignment.Bottom,
      customStyle: true,
      autoCancel: true
    });
    this.addController.open();
  }

  async toggleFinish(todo: TodoRecord) { const newStatus = todo.isFinished === 1 ? 0 : 1; await dbHelper.updateTodoStatus(todo.id, newStatus); this.refreshData(); }
  async handleDelete(id: number) { await dbHelper.deleteTodo(id); this.refreshData(); }
  getDateTitle(): string { return `${this.selectedDate.getMonth() + 1}æœˆ${this.selectedDate.getDate()}æ—¥`; }

  getProgressPercent(): number {
    if (this.totalCount === 0) return 0;
    return Math.round((this.finishedCount / this.totalCount) * 100);
  }

  getProgressBgColor(): ResourceColor {
    return $r('app.color.divider');
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Column() {
          Row({ space: 4 }) {
            Text("å¾…åŠæ¸…å•").fontSize(24).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
            Button({ type: ButtonType.Circle }) { SymbolGlyph($r('sys.symbol.calendar')).fontSize(20).fontColor([$r('app.color.accent')]) }
            .width(32).height(32).backgroundColor($r('app.color.input_bg')).onClick(() => this.openDatePicker())
          }.alignItems(VerticalAlign.Center)

          Text(this.getDateTitle()).fontSize(14).fontColor($r('app.color.text_secondary')).margin({ top: 4, left: 2 })
        }.alignItems(HorizontalAlign.Start)

        Blank()

        // è¿›åº¦ç¯
        Stack({ alignContent: Alignment.Center }) {
          Progress({ value: this.finishedCount, total: this.totalCount, type: ProgressType.Ring })
            .width(50).height(50)
            .color($r('app.color.accent'))
            .backgroundColor(this.getProgressBgColor())
            .style({ strokeWidth: 5 });

          Column({ space: 2 }) {
            Text(`${this.getProgressPercent()}%`)
              .fontSize(12).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
            Text(`${this.finishedCount}/${this.totalCount}`)
              .fontSize(8).fontColor($r('app.color.text_secondary'))
          }
        }
      }
      .width('100%').padding({ left: 20, right: 20, top: 56, bottom: 15 }).backgroundColor($r('app.color.page_bg'))

      // åˆ—è¡¨åŒºåŸŸ
      if (this.totalCount === 0) {
        Column() {
          SymbolGlyph($r('sys.symbol.doc_plaintext')).fontSize(50).fontColor([$r('app.color.text_secondary')]);
          Text('æš‚æ— å¾…åŠï¼Œç‚¹å³ä¸‹è§’æ·»åŠ ').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ top: 10 })
        }.width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else {
        List({ space: 10 }) {
          if (this.unfinishedList.length > 0) {
            ListItem() {
              Text('è¿›è¡Œä¸­').fontSize(14).fontWeight(FontWeight.Bold).fontColor($r('app.color.accent')).margin({ left: 5, bottom: 5 })
            }
            ForEach(this.unfinishedList, (item: TodoRecord) => {
              TodoItemCard({
                item: item,
                onToggle: () => { this.toggleFinish(item) },
                onDelete: () => { this.handleDelete(item.id) }
              })
            }, (item: TodoRecord) => item.id.toString())
          }

          if (this.finishedList.length > 0) {
            ListItem() {
              Text('å·²å®Œæˆ').fontSize(14).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_secondary')).margin({ left: 5, top: 10, bottom: 5 })
            }
            ForEach(this.finishedList, (item: TodoRecord) => {
              TodoItemCard({
                item: item,
                onToggle: () => { this.toggleFinish(item) },
                onDelete: () => { this.handleDelete(item.id) }
              })
            }, (item: TodoRecord) => item.id.toString())
          }

          ListItem().height(80)
        }
        .width('100%').layoutWeight(1).padding({ left: 15, right: 15 }).scrollBar(BarState.Off)
      }

      // ==========================================
      // ã€æ‚¬æµ®æŒ‰é’®åŒºåŸŸã€‘
      // ==========================================
      Row() {
        Button() {
          Row() {
            SymbolGlyph($r('sys.symbol.list_checkmask')).fontSize(24).fontColor([Color.White]).margin({ right: 8 });
            Text('æ–°å»ºå¾…åŠ').fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
          }
        }
        .height(50).padding({ left: 20, right: 20 }).backgroundColor($r('app.color.accent')).borderRadius(25).shadow({ radius: 10, color: '#40007DFF', offsetY: 5 })
        .onClick(() => this.openAddTodo())
        .scale({ x: this.floatingButtonScale, y: this.floatingButtonScale })
        .onTouch((event: TouchEvent) => {
          animateTo({ duration: 100, curve: Curve.EaseOut }, () => {
            if (event.type === TouchType.Down) {
              this.floatingButtonScale = 0.95;
            } else if (event.type === TouchType.Up) {
              this.floatingButtonScale = 1.0;
            }
          });
        })
      }
      .width('100%')

      // ä½ç½®ï¼š80% é«˜åº¦
      .position({ x: 0, y: '80%' })

      // å¸ƒå±€å¯¹é½ï¼šæ ¹æ®æ¡æŒæ‰‹åŠ¨æ€è°ƒæ•´
      .justifyContent(this.isRightHand ? FlexAlign.End : FlexAlign.Start)

      .padding({ left: 20, right: 20 })

      // åŠ¨ç”»ä½ç§»ä¸é€æ˜åº¦
      .translate({ x: this.offsetX })
      .opacity(this.opacityValue)

      .hitTestBehavior(HitTestMode.Transparent)

    }.width('100%').height('100%').backgroundColor($r('app.color.page_bg'))
  }
}
